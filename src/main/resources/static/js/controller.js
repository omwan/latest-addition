app.controller('controller', ['$scope', '$http', '$mdDialog', 
    function ($scope, $http, $mdDialog) {

    $scope.playlists = null;
    $scope.selectedPlaylists = [];

    $scope.playlistSort = "$index";
    $scope.playlistSortReverse = false;

    $scope.playlistFilter = "";

    $scope.playlistDetails = {};

    $scope.submissionForm = {
        playlistName: "Latest Additions",
        numTracks: 25,
        overwriteExisting: false,
        description: null,
        isPublic: false,
        isCollaborative: false,
        playlistUris: {},
        playlistToOverwrite: null
    }

    $scope.existingPlaylists = [];

    var _getPlaylists = function () {
        $http.get("/api/playlist/userplaylists")
        // $http.get("../mock_responses/playlists.json")
        .then(function (response) {
            if (response !== "") {
                $scope.playlists = response.data;
            }
        });
    };

    $scope.loadMorePlaylists = function () {
        if ($scope.playlists) {
            $http.get("/api/playlist/userplaylists", {
                "params": {
                    "offset": $scope.playlists.offset + $scope.playlists.limit,
                    "limit": $scope.playlists.limit
                }
            })
            .then(function (response) {
                if (response.data !== null || response.data !== "") {
                    var origPlaylists = $scope.playlists.items;
                    $scope.playlists = response.data;
                    origPlaylists.push.apply(origPlaylists, $scope.playlists.items);
                    $scope.playlists.items = origPlaylists;
                }
            });
        } else {
            return null;
        }
    };

    $scope.getPlaylistDetails = function (uri, event) {
        $mdDialog.show({
            locals: {
                uri: uri,
                playlistDetails: $scope.playlistDetails
            },
            controller: DialogController,
            templateUrl: '../templates/playlist-details.tpl.html',
            parent: angular.element(document.body),
            targetEvent: event,
            clickOutsideToClose:true
        });
    };

    function DialogController($scope, $mdDialog, playlistDetails, uri) {
        $scope.hide = function() {
            $mdDialog.hide();
        };

        if (uri in playlistDetails) {
            $scope.playlist = playlistDetails[uri];
        } else {
            $http.get("/api/playlist/details", {
                "params": {
                    "uri": uri
                }
            })
            .then(function (response) {
                if (response.data !== null || response.data !== "") {
                    playlistDetails[uri] = response.data;
                    $scope.playlist = response.data;
                }
            });
        }
    }

    $scope.toggle = function (item, list) {
        var idx = list.indexOf(item);
        if (idx > -1) {
            list.splice(idx, 1);
        }
        else {
            list.push(item);
        }
    };

    $scope.exists = function (item, list) {
        return list.indexOf(item) > -1;
    };

    $scope.submitForm = function() {
        $scope.selectedPlaylists.forEach(function(playlist) {
            $scope.submissionForm.playlistUris[playlist.uri] = playlist.tracks.total;
        });
        if ($scope.submissionForm.description === "" 
            || $scope.submissionForm.description === null) {
            var playlistNames = $scope.selectedPlaylists
                .map(x => x.name)
                .join(", ");
            $scope.submissionForm.description = "Autogenerated playlist containing " 
                + "last added tracks from the following playlists: "
                + playlistNames
                + ". See source code at: https://github.com/omwan/latest-addition"
        }
        $http.post("/api/playlist/build", $scope.submissionForm);
        // console.log($scope.submissionForm.description);
        $scope.submissionForm.description = null;
    };

    var _getExistingPlaylists = function() {
        $http.get("/api/playlist/existing")
        // $http.get("../mock_responses/existing_playlists.json")
        .then(function(response) {
            $scope.existingPlaylists = response.data;
        });
    };

    var _init = function() {
        if ($scope.playlists === null || $scope.playlists === "") {
            _getPlaylists();
            _getExistingPlaylists();
        }
    };

    _init();
}]);